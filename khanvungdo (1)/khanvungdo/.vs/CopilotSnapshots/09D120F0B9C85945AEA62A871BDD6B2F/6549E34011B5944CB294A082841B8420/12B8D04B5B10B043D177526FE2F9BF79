using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Windows.Forms;
using WindowsFormsApp2.Infrastructure;

namespace WindowsFormsApp2
{
    public partial class frmDichVu : Form
    {
        public frmDichVu()
        {
            InitializeComponent();
            Load += FrmDichVu_Load;
            lvDSDV.SelectedIndexChanged += LvDSDV_SelectedIndexChanged;
            btnThem.Click += BtnThem_Click;
            btnXoa.Click += BtnXoa_Click;
            btnTim.Click += BtnTim_Click;
            guna2Button1.Click += BtnCapNhat_Click; // nút cập nhật
        }

        private void FrmDichVu_Load(object sender, EventArgs e)
        {
            LoadLoaiDichVu();
            LoadDanhSachDichVu();
        }

        private class LoaiItem
        {
            public int Id { get; set; }
            public string Name { get; set; }
            public override string ToString() => Name;
        }

        private void LoadLoaiDichVu()
        {
            comboBox1.Items.Clear();
            using (var conn = Db.Open())
            using (var cmd = new SqlCommand("USP_XuatLoaiDichVu", conn))
            {
                cmd.CommandType = CommandType.StoredProcedure;
                using (var rd = cmd.ExecuteReader())
                {
                    while (rd.Read())
                    {
                        comboBox1.Items.Add(new LoaiItem
                        {
                            Id = Convert.ToInt32(rd["id"]),
                            Name = rd["name"].ToString()
                        });
                    }
                }
            }
            if (comboBox1.Items.Count > 0)
                comboBox1.SelectedIndex = 0;
        }

        private void LoadDanhSachDichVu(string keyword = null, int? id = null)
        {
            lvDSDV.Items.Clear();
            var sql = @"SELECT dv.id, dv.TenDV, dv.DVT, dv.DonGia, dv.LuuY, l.name AS Loai
                        FROM dbo.DSDichVu dv JOIN dbo.LoaiDichVu l ON l.id = dv.idLoaiDichVu
                        WHERE (ISNULL(@kw,'') = '' OR dv.TenDV LIKE '%' + @kw + '%')
                          AND (@id IS NULL OR dv.id = @id)
                        ORDER BY dv.id";
            using (var conn = Db.Open())
            using (var cmd = new SqlCommand(sql, conn))
            {
                cmd.Parameters.AddWithValue("@kw", (object)(keyword ?? string.Empty));
                cmd.Parameters.AddWithValue("@id", (object)id ?? DBNull.Value);
                using (var rd = cmd.ExecuteReader())
                {
                    int stt = 1;
                    while (rd.Read())
                    {
                        var item = new ListViewItem(stt.ToString());
                        item.SubItems.Add(""); // Hình - không lưu trong DB
                        item.SubItems.Add(Convert.ToString(rd["id"]));
                        item.SubItems.Add(rd["TenDV"].ToString());
                        item.SubItems.Add(rd["Loai"].ToString());
                        item.SubItems.Add(string.Format("{0:N0}", rd["DonGia"]));
                        item.SubItems.Add(rd["DVT"].ToString());
                        item.SubItems.Add(rd["LuuY"] == DBNull.Value ? string.Empty : rd["LuuY"].ToString());
                        lvDSDV.Items.Add(item);
                        stt++;
                    }
                }
            }
        }

        private void LvDSDV_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (lvDSDV.SelectedItems.Count == 0) return;
            var it = lvDSDV.SelectedItems[0];
            txtMaDV.Text = it.SubItems[2].Text;
            txtTenDV.Text = it.SubItems[3].Text;
            var loaiText = it.SubItems[4].Text;
            for (int i = 0; i < comboBox1.Items.Count; i++)
            {
                if ((comboBox1.Items[i] as LoaiItem)?.Name == loaiText)
                {
                    comboBox1.SelectedIndex = i; break;
                }
            }
            txtDonGia.Text = it.SubItems[5].Text.Replace(",", string.Empty);
            txtDVT.Text = it.SubItems[6].Text;
            txtLuuY.Text = it.SubItems[7].Text;
        }

        private void BtnTim_Click(object sender, EventArgs e)
        {
            int id;
            if (int.TryParse(txtMaDV.Text.Trim(), out id))
            {
                LoadDanhSachDichVu(null, id);
            }
            else
            {
                var kw = string.IsNullOrWhiteSpace(txtTenDV.Text) ? null : txtTenDV.Text.Trim();
                LoadDanhSachDichVu(kw, null);
            }
        }

        private void BtnThem_Click(object sender, EventArgs e)
        {
            if (comboBox1.SelectedItem == null)
            {
                MessageBox.Show("Chọn loại dịch vụ"); return;
            }
            var ten = txtTenDV.Text.Trim();
            var dvt = txtDVT.Text.Trim();
            var luuy = string.IsNullOrWhiteSpace(txtLuuY.Text) ? (object)DBNull.Value : txtLuuY.Text.Trim();
            decimal dongia;
            if (string.IsNullOrWhiteSpace(ten) || string.IsNullOrWhiteSpace(dvt) || !decimal.TryParse(txtDonGia.Text, out dongia))
            {
                MessageBox.Show("Nhập Tên, ĐVT và Đơn giá hợp lệ."); return;
            }
            var loaiId = (comboBox1.SelectedItem as LoaiItem).Id;

            using (var conn = Db.Open())
            using (var cmd = new SqlCommand("INSERT dbo.DSDichVu(TenDV, idLoaiDichVu, DonGia, DVT, LuuY) VALUES(@Ten,@Loai,@Gia,@DVT,@LuuY)", conn))
            {
                cmd.Parameters.AddWithValue("@Ten", ten);
                cmd.Parameters.AddWithValue("@Loai", loaiId);
                cmd.Parameters.AddWithValue("@Gia", dongia);
                cmd.Parameters.AddWithValue("@DVT", dvt);
                cmd.Parameters.AddWithValue("@LuuY", luuy);
                try
                {
                    cmd.ExecuteNonQuery();
                    MessageBox.Show("Đã thêm dịch vụ.");
                    ClearInputs();
                    LoadDanhSachDichVu();
                }
                catch (SqlException ex)
                {
                    MessageBox.Show("Lỗi khi thêm: " + ex.Message);
                }
            }
        }

        private void BtnCapNhat_Click(object sender, EventArgs e)
        {
            int id;
            if (!int.TryParse(txtMaDV.Text.Trim(), out id))
            {
                MessageBox.Show("Nhập mã DV hợp lệ để cập nhật."); return;
            }
            if (comboBox1.SelectedItem == null)
            {
                MessageBox.Show("Chọn loại dịch vụ"); return;
            }
            var ten = txtTenDV.Text.Trim();
            var dvt = txtDVT.Text.Trim();
            var luuy = string.IsNullOrWhiteSpace(txtLuuY.Text) ? (object)DBNull.Value : txtLuuY.Text.Trim();
            decimal dongia;
            if (string.IsNullOrWhiteSpace(ten) || string.IsNullOrWhiteSpace(dvt) || !decimal.TryParse(txtDonGia.Text, out dongia))
            {
                MessageBox.Show("Nhập Tên, ĐVT và Đơn giá hợp lệ."); return;
            }
            var loaiId = (comboBox1.SelectedItem as LoaiItem).Id;

            using (var conn = Db.Open())
            using (var cmd = new SqlCommand(@"UPDATE dbo.DSDichVu
                                            SET TenDV=@Ten, idLoaiDichVu=@Loai, DonGia=@Gia, DVT=@DVT, LuuY=@LuuY
                                            WHERE id=@Id", conn))
            {
                cmd.Parameters.AddWithValue("@Id", id);
                cmd.Parameters.AddWithValue("@Ten", ten);
                cmd.Parameters.AddWithValue("@Loai", loaiId);
                cmd.Parameters.AddWithValue("@Gia", dongia);
                cmd.Parameters.AddWithValue("@DVT", dvt);
                cmd.Parameters.AddWithValue("@LuuY", luuy);
                try
                {
                    var rows = cmd.ExecuteNonQuery();
                    if (rows == 0) { MessageBox.Show("Không tìm thấy DV để cập nhật."); return; }
                    MessageBox.Show("Đã cập nhật dịch vụ.");
                    ClearInputs();
                    LoadDanhSachDichVu();
                }
                catch (SqlException ex)
                {
                    MessageBox.Show("Lỗi khi cập nhật: " + ex.Message);
                }
            }
        }

        private void BtnXoa_Click(object sender, EventArgs e)
        {
            var ids = new List<int>();
            foreach (ListViewItem it in lvDSDV.Items)
            {
                if (it.Checked)
                {
                    int id; if (int.TryParse(it.SubItems[2].Text, out id)) ids.Add(id);
                }
            }
            if (ids.Count == 0 && lvDSDV.SelectedItems.Count > 0)
            {
                int id; if (int.TryParse(lvDSDV.SelectedItems[0].SubItems[2].Text, out id)) ids.Add(id);
            }
            if (ids.Count == 0)
            {
                MessageBox.Show("Chọn ít nhất một dịch vụ để xóa."); return;
            }
            if (MessageBox.Show($"Xóa {ids.Count} dịch vụ?", "Xác nhận", MessageBoxButtons.YesNo, MessageBoxIcon.Question) != DialogResult.Yes)
                return;

            using (var conn = Db.Open())
            using (var cmd = new SqlCommand("DELETE dbo.DSDichVu WHERE id=@Id", conn))
            {
                cmd.Parameters.Add("@Id", SqlDbType.Int);
                try
                {
                    foreach (var id in ids)
                    {
                        cmd.Parameters["@Id"].Value = id;
                        cmd.ExecuteNonQuery();
                    }
                    MessageBox.Show("Đã xóa.");
                    LoadDanhSachDichVu();
                }
                catch (SqlException ex)
                {
                    MessageBox.Show("Lỗi khi xóa: " + ex.Message);
                }
            }
        }

        private void ClearInputs()
        {
            txtMaDV.Clear();
            txtTenDV.Clear();
            txtDVT.Clear();
            txtDonGia.Clear();
            txtLuuY.Clear();
            if (comboBox1.Items.Count > 0) comboBox1.SelectedIndex = 0;
        }
    }
}
