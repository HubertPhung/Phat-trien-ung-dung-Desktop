using System;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Windows.Forms;
using WindowsFormsApp2.Infrastructure;
using WindowsFormsApp2.Security;

namespace WindowsFormsApp2
{
	public partial class frmDangNhap : Form
	{
        private int _failCount = 0;
        private Timer _unlockTimer;
        private Timer _showPwTimer;
        private CheckBox _chkShowPw;

		public frmDangNhap()
		{
			InitializeComponent();
            this.Load += FrmDangNhap_Load;
            this.KeyPreview = true;
            this.KeyDown += FrmDangNhap_KeyDown;

            // Hook key handlers for textboxes
            txtTenTaiKhoan.KeyDown += (s,e)=>
            {
                if (e.KeyCode == Keys.Enter)
                {
                    e.SuppressKeyPress = true;
                    txtMatKhau.Focus();
                }
                else if (e.KeyCode == Keys.Escape)
                {
                    ClearInputs();
                    txtTenTaiKhoan.Focus();
                }
            };
            txtMatKhau.KeyDown += (s,e)=>
            {
                if (e.KeyCode == Keys.Enter)
                {
                    e.SuppressKeyPress = true;
                    btnDangNhap.PerformClick();
                }
                else if (e.KeyCode == Keys.Escape)
                {
                    ClearInputs();
                    txtTenTaiKhoan.Focus();
                }
            };
		}

        private void FrmDangNhap_Load(object sender, EventArgs e)
        {
            // Init timers
            _unlockTimer = new Timer { Interval = 5 * 60 * 1000 }; // 5 minutes
            _unlockTimer.Tick += (s, ev) =>
            {
                _unlockTimer.Stop();
                _failCount = 0;
                btnDangNhap.Enabled = true;
            };
            _showPwTimer = new Timer { Interval = 5 * 1000 }; // 5 seconds
            _showPwTimer.Tick += (s, ev) =>
            {
                _showPwTimer.Stop();
                if (_chkShowPw != null && _chkShowPw.Checked)
                {
                    _chkShowPw.Checked = false; // will toggle back to masked
                }
            };

            // DB connection check
            try { using (var c = Db.Open()) { } }
            catch
            {
                MessageBox.Show("Lỗi kết nối database", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
                btnDangNhap.Enabled = false;
            }

            // Default UI state
            ClearInputs();
            try { txtMatKhau.UseSystemPasswordChar = true; } catch { }
            txtTenTaiKhoan.Focus();

            // Wire show password checkbox if present
            _chkShowPw = FindShowPasswordCheckbox();
            if (_chkShowPw != null)
            {
                _chkShowPw.Checked = false;
                _chkShowPw.CheckedChanged += (s, ev) =>
                {
                    bool show = _chkShowPw.Checked;
                    try { txtMatKhau.UseSystemPasswordChar = !show; } catch { }
                    if (show)
                    {
                        _showPwTimer.Stop();
                        _showPwTimer.Start();
                    }
                    else
                    {
                        _showPwTimer.Stop();
                    }
                };
            }

            // If already logged in, redirect
            if (!string.IsNullOrWhiteSpace(UserContext.TenTaiKhoan))
            {
                MessageBox.Show("Bạn đã đăng nhập");
                this.Hide();
                using (var main = new frmMain())
                {
                    main.ShowDialog();
                }
                this.Close();
                return;
            }
        }

        private CheckBox FindShowPasswordCheckbox()
        {
            // Try common names or by text
            var chk = this.Controls.OfType<CheckBox>().FirstOrDefault(c =>
                string.Equals(c.Name, "chkShowPassword", StringComparison.OrdinalIgnoreCase) ||
                string.Equals(c.Name, "chkHienMatKhau", StringComparison.OrdinalIgnoreCase) ||
                string.Equals(c.Name, "cbHienMatKhau", StringComparison.OrdinalIgnoreCase) ||
                (c.Text ?? string.Empty).IndexOf("hiển thị mật khẩu", StringComparison.OrdinalIgnoreCase) >= 0);
            if (chk != null) return chk;

            // search recursively
            foreach (Control parent in this.Controls)
            {
                chk = parent.Controls.OfType<CheckBox>().FirstOrDefault(c => (c.Text ?? string.Empty).IndexOf("hiển thị mật khẩu", StringComparison.OrdinalIgnoreCase) >= 0);
                if (chk != null) return chk;
            }
            return null;
        }

        private void FrmDangNhap_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Escape)
            {
                ClearInputs();
                txtTenTaiKhoan.Focus();
            }
        }

        private void ClearInputs()
        {
            txtTenTaiKhoan.Text = string.Empty;
            txtMatKhau.Text = string.Empty;
        }

        private void btnDangNhap_Click(object sender, EventArgs e)
        {
            var user = txtTenTaiKhoan.Text.Trim();
            var pass = txtMatKhau.Text;

            // basic validation
            if (string.IsNullOrWhiteSpace(user)) { MessageBox.Show("Vui lòng nhập tên đăng nhập"); txtTenTaiKhoan.Focus(); return; }
            if (string.IsNullOrWhiteSpace(pass)) { MessageBox.Show("Vui lòng nhập mật khẩu"); txtMatKhau.Focus(); return; }

            // lockout
            if (_failCount >= 5)
            {
                MessageBox.Show("Bạn đã thử đăng nhập quá nhiều lần. Vui lòng thử lại sau 5 phút.");
                btnDangNhap.Enabled = false;
                if (!_unlockTimer.Enabled) _unlockTimer.Start();
                return;
            }

            try
            {
                using (var conn = Db.Open())
                using (var cmd = new SqlCommand("USP_Login", conn))
                {
                    cmd.CommandType = CommandType.StoredProcedure;
                    cmd.Parameters.AddWithValue("@TenTaiKhoan", user);
                    cmd.Parameters.AddWithValue("@password", pass);
                    using (var rd = cmd.ExecuteReader())
                    {
                        if (rd.Read())
                        {
                            UserContext.MaTaiKhoan = Convert.ToString(rd["MaTaiKhoan"]);
                            UserContext.TenTaiKhoan = Convert.ToString(rd["TenTaiKhoan"]);
                            UserContext.Type = Convert.ToInt32(rd["Type"]);

                            // reset
                            _failCount = 0; _unlockTimer.Stop();

                            // redirect to main
                            this.Hide();
                            using (var main = new frmMain())
                            {
                                main.ShowDialog();
                            }
                            this.Close();
                            return;
                        }
                    }
                }

                // failed
                _failCount++;
                var remain = Math.Max(0, 5 - _failCount);
                MessageBox.Show(remain > 0 ? $"Sai tên đăng nhập hoặc mật khẩu. Bạn còn {remain} lần thử" : "Sai tên đăng nhập hoặc mật khẩu.");
                txtMatKhau.Clear();
                txtMatKhau.Focus();
                if (_failCount >= 5)
                {
                    btnDangNhap.Enabled = false;
                    if (!_unlockTimer.Enabled) _unlockTimer.Start();
                }
            }
            catch
            {
                MessageBox.Show("Lỗi kết nối database. Vui lòng kiểm tra kết nối.");
            }
        }

        private void btnQuenMatKhau_Click(object sender, EventArgs e)
        {
            var user = txtTenTaiKhoan.Text.Trim();
            if (string.IsNullOrWhiteSpace(user))
            {
                MessageBox.Show("Vui lòng nhập tên đăng nhập trước");
                txtTenTaiKhoan.Focus();
                return;
            }

            try
            {
                using (var conn = Db.Open())
                using (var cmd = new SqlCommand("SELECT COUNT(1) FROM dbo.TaiKhoan WHERE TenTaiKhoan=@u", conn))
                {
                    cmd.Parameters.AddWithValue("@u", user);
                    var exists = (int)cmd.ExecuteScalar() > 0;
                    if (!exists)
                    {
                        MessageBox.Show("Tên đăng nhập không tồn tại");
                        return;
                    }
                }
            }
            catch
            {
                MessageBox.Show("Không thể kết nối database. Vui lòng kiểm tra kết nối mạng.");
                return;
            }

            // Open forgot password form
            frmQuenMatKhau frm = new frmQuenMatKhau(this);
            this.Hide();
            frm.Show();
            frm.FormClosed += (s, args) => this.Show();
        }

        protected override void OnFormClosing(FormClosingEventArgs e)
        {
            base.OnFormClosing(e);
            if (string.IsNullOrWhiteSpace(UserContext.TenTaiKhoan))
            {
                var ans = MessageBox.Show("Bạn có chắc muốn thoát ứng dụng?", "Xác nhận", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                if (ans != DialogResult.Yes) { e.Cancel = true; return; }
            }
            try { txtMatKhau.Clear(); } catch { }
            try { _unlockTimer?.Dispose(); _showPwTimer?.Dispose(); } catch { }
            try { System.Diagnostics.Debug.WriteLine("Đóng form đăng nhập"); } catch { }
        }
	}
}
