using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Globalization;
using System.Linq;
using System.Text.RegularExpressions;
using System.Windows.Forms;
using WindowsFormsApp2.Infrastructure;
using WindowsFormsApp2.Security;
using WindowsFormsApp2.Validation;
using WindowsFormsApp2.Models;
using WindowsFormsApp2.Services;

namespace WindowsFormsApp2
{
    public partial class frmKhachHang : Form
    {
        private bool _isAdminOrStaff; // admin or staff can access
        private bool _isAdmin;        // only admin can edit/delete
        private bool _dirtyInputs;

        public frmKhachHang()
        {
            InitializeComponent();
            Load += FrmKhachHang_Load;
            btnThem.Click += BtnThem_Click;
            btnSua.Click += BtnSua_Click;
            btnXoa.Click += BtnXoa_Click;
            btnTim.Click += BtnTim_Click;
            lvKhachHang.SelectedIndexChanged += LvKhachHang_SelectedIndexChanged;
            this.FormClosing += FrmKhachHang_FormClosing;

            txtTenKH.TextChanged += TxtTenKH_TextChanged;
            mtxtCMND.TextChanged += MtxtCMND_TextChanged;
            mtxtSDTKH.TextChanged += MtxtSDTKH_TextChanged;
            txtDiaChiKH.TextChanged += (s,e)=> _dirtyInputs = true;

            // Ensure masks/maxlength allow 10 digits for phone
            try { mtxtSDTKH.MaxLength = 20; } catch { }
        }

        private void FrmKhachHang_Load(object sender, EventArgs e)
        {
            _isAdmin = UserContext.Type == 1;
            _isAdminOrStaff = (UserContext.Type == 1 || UserContext.Type == 0);
            if (!_isAdminOrStaff)
            {
                MessageBox.Show("Bạn không có quyền truy cập");
                SetButtonsEnabled(false);
                return;
            }

            try { using (var c = Db.Open()) { } }
            catch
            {
                MessageBox.Show("Mất kết nối database", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
                SetButtonsEnabled(false);
                return;
            }

            try { mtxtCMND.MaxLength = 12; } catch { }
            try { mtxtSDTKH.MaxLength = 12; } catch { }

            LoadKhachHang();
            ResetInputs();
            UpdateButtonsOnSelection(false);
        }

        private void SetButtonsEnabled(bool enabled)
        {
            btnThem.Enabled = enabled && _isAdminOrStaff;
            btnSua.Enabled = false;
            btnXoa.Enabled = false;
            btnTim.Enabled = enabled;
        }

        private void ResetInputs()
        {
            txtMaKH.Clear();
            txtTenKH.Clear();
            mtxtCMND.Clear();
            txtDiaChiKH.Clear();
            mtxtSDTKH.Clear();
            _dirtyInputs = false;

            try
            {
                var cb = this.GetType().GetField("cbLoaiKH", System.Reflection.BindingFlags.Instance | System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Public)?.GetValue(this) as ComboBox;
                if (cb != null)
                {
                    if (cb.Items.Count == 0)
                    {
                        cb.Items.AddRange(new object[] { "Khách lẻ", "VIP" });
                    }
                    cb.SelectedIndex = 0;
                }
            }
            catch { }
        }

        private void UpdateButtonsOnSelection(bool hasSelection)
        {
            btnThem.Enabled = _isAdminOrStaff;
            btnSua.Enabled = hasSelection && _isAdmin;
            btnXoa.Enabled = hasSelection && _isAdmin;
        }

        private void LoadKhachHang(string keyword = null, int? id = null)
        {
            lvKhachHang.Items.Clear();
            var list = QLKhachHang.Find(keyword, id);
            foreach (var kh in list)
            {
                var item = new ListViewItem(kh.Id.ToString()) { BackColor = System.Drawing.Color.White };
                item.SubItems.Add(kh.TenKH ?? "");
                item.SubItems.Add(kh.CMND_CCCD ?? "");
                item.SubItems.Add(kh.DiaChi ?? "");
                item.SubItems.Add(kh.SDT ?? "");
                item.SubItems.Add(kh.LoaiKH ?? "");
                item.SubItems.Add(kh.GhiChu ?? "");
                lvKhachHang.Items.Add(item);
            }
        }

        private void LvKhachHang_SelectedIndexChanged(object sender, EventArgs e)
        {
            foreach (ListViewItem itAll in lvKhachHang.Items) itAll.BackColor = System.Drawing.Color.White;
            if (lvKhachHang.SelectedItems.Count == 0)
            {
                ResetInputs();
                UpdateButtonsOnSelection(false);
                return;
            }

            var it = lvKhachHang.SelectedItems[0];
            it.BackColor = System.Drawing.Color.AliceBlue;

            txtMaKH.Text = it.SubItems[0].Text;
            txtTenKH.Text = it.SubItems[1].Text;
            mtxtCMND.Text = it.SubItems[2].Text;
            txtDiaChiKH.Text = it.SubItems[3].Text;
            mtxtSDTKH.Text = it.SubItems[4].Text;

            try
            {
                var cb = this.GetType().GetField("cbLoaiKH", System.Reflection.BindingFlags.Instance | System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Public)?.GetValue(this) as ComboBox;
                if (cb != null)
                {
                    var loai = it.SubItems.Count > 5 ? it.SubItems[5].Text : "Khách lẻ";
                    int idx = cb.Items.IndexOf(loai);
                    if (idx >= 0) cb.SelectedIndex = idx;
                }
            }
            catch { }

            UpdateButtonsOnSelection(true);
            _dirtyInputs = false;
        }

        private void BtnTim_Click(object sender, EventArgs e)
        {
            int id;
            if (int.TryParse(txtMaKH.Text.Trim(), out id)) LoadKhachHang(null, id);
            else LoadKhachHang(string.IsNullOrWhiteSpace(txtTenKH.Text) ? null : txtTenKH.Text.Trim(), null);
        }

        private bool ValidateInputs(out string ten, out string cmnd, out string sdt, out string diachi, out string loaikh)
        {
            ten = txtTenKH.Text.Trim();
            cmnd = new string(mtxtCMND.Text.Where(char.IsDigit).ToArray());
            sdt = new string(mtxtSDTKH.Text.Where(char.IsDigit).ToArray());
            diachi = string.IsNullOrWhiteSpace(txtDiaChiKH.Text) ? null : txtDiaChiKH.Text.Trim();
            loaikh = "Khách lẻ";
            try
            {
                var cb = this.GetType().GetField("cbLoaiKH", System.Reflection.BindingFlags.Instance | System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Public)?.GetValue(this) as ComboBox;
                if (cb != null && cb.SelectedItem != null) loaikh = cb.SelectedItem.ToString();
            }
            catch { }

            if (string.IsNullOrWhiteSpace(ten)) { MessageBox.Show("Vui lòng nhập Tên khách hàng"); return false; }
            if (string.IsNullOrWhiteSpace(cmnd) || !cmnd.All(char.IsDigit)) { MessageBox.Show("CMND/CCCD phải là số"); return false; }
            if (!(cmnd.Length == 9 || cmnd.Length == 12)) { MessageBox.Show("CMND phải 9 số, CCCD phải 12 số"); return false; }
            if (!string.IsNullOrWhiteSpace(sdt))
            {
                if (!Validators.IsValidVietnamPhone(sdt)) { MessageBox.Show("Số điện thoại không hợp lệ (phải 10-11 số và bắt đầu bằng 0)"); return false; }
            }
            return true;
        }

        private void BtnThem_Click(object sender, EventArgs e)
        {
            if (!_isAdminOrStaff) { MessageBox.Show("Bạn không có quyền truy cập"); return; }
            if (!ValidateInputs(out var ten, out var cmnd, out var sdt, out var diachi, out var loaikh)) return;

            if (QLKhachHang.ExistsByCMND(cmnd))
            {
                MessageBox.Show("CMND/CCCD đã tồn tại trong hệ thống");
                mtxtCMND.Focus();
                return;
            }

            var kh = new KhachHang { TenKH = ten, CMND_CCCD = cmnd, DiaChi = diachi, SDT = sdt, LoaiKH = loaikh };
            try
            {
                var newId = QLKhachHang.Insert(kh);
                MessageBox.Show("Thêm khách hàng mới thành công!");
                ResetInputs();
                LoadKhachHang();
                foreach (ListViewItem it in lvKhachHang.Items)
                {
                    if (it.SubItems[0].Text == newId.ToString())
                    { it.Selected = true; it.Focused = true; it.EnsureVisible(); break; }
                }
            }
            catch (SqlException ex)
            {
                MessageBox.Show("Lỗi khi thêm khách hàng: " + ex.Message);
            }
        }

        private void BtnSua_Click(object sender, EventArgs e)
        {
            if (!_isAdmin) { MessageBox.Show("Bạn không có quyền truy cập"); return; }
            int id; if (!int.TryParse(txtMaKH.Text.Trim(), out id)) { MessageBox.Show("Phải chọn khách hàng để sửa."); return; }
            if (!ValidateInputs(out var ten, out var cmnd, out var sdt, out var diachi, out var loaikh)) return;

            if (MessageBox.Show("Bạn có chắc muốn cập nhật thông tin khách hàng này?", "Xác nhận", MessageBoxButtons.YesNo, MessageBoxIcon.Question) != DialogResult.Yes) return;

            if (QLKhachHang.HasInvoices(id))
                MessageBox.Show("Khách hàng đang có hóa đơn. Việc thay đổi có thể ảnh hưởng đến lịch sử giao dịch.");

            var kh = new KhachHang { Id = id, TenKH = ten, CMND_CCCD = cmnd, DiaChi = diachi, SDT = sdt, LoaiKH = loaikh };
            try
            {
                var rows = QLKhachHang.Update(kh);
                if (rows == 0) { MessageBox.Show("Không tìm thấy KH để sửa."); return; }
                MessageBox.Show("Cập nhật khách hàng thành công!");
                LoadKhachHang();
                foreach (ListViewItem it in lvKhachHang.Items)
                {
                    if (it.SubItems[0].Text == id.ToString())
                    { it.Selected = true; it.Focused = true; it.EnsureVisible(); break; }
                }
                _dirtyInputs = false;
            }
            catch (SqlException ex)
            {
                MessageBox.Show("Lỗi khi sửa: " + ex.Message);
            }
        }

        private void BtnXoa_Click(object sender, EventArgs e)
        {
            if (!_isAdmin) { MessageBox.Show("Bạn không có quyền truy cập"); return; }
            var ids = new List<int>();
            foreach (ListViewItem it in lvKhachHang.Items)
                if (it.Checked) { int id; if (int.TryParse(it.SubItems[0].Text, out id)) ids.Add(id); }
            if (ids.Count == 0 && lvKhachHang.SelectedItems.Count > 0)
            { int id; if (int.TryParse(lvKhachHang.SelectedItems[0].SubItems[0].Text, out id)) ids.Add(id); }
            if (ids.Count == 0) { MessageBox.Show("Chọn ít nhất một KH để xóa."); return; }

            // filter out those having invoices
            ids = ids.Where(id =>
            {
                if (QLKhachHang.HasInvoices(id))
                {
                    MessageBox.Show($"Không thể xóa khách hàng ID {id} vì đang có hóa đơn trong hệ thống.");
                    return false;
                }
                return true;
            }).ToList();

            if (ids.Count == 0) return;
            if (MessageBox.Show($"Bạn có chắc muốn xóa {ids.Count} khách hàng đã chọn? Dữ liệu không thể khôi phục!", "Xác nhận", MessageBoxButtons.YesNo, MessageBoxIcon.Warning) != DialogResult.Yes) return;
            try
            {
                QLKhachHang.Delete(ids);
                MessageBox.Show("Xóa khách hàng thành công!");
                ResetInputs();
                LoadKhachHang();
            }
            catch (SqlException ex)
            { MessageBox.Show("Không thể xóa vì khách hàng đang có giao dịch trong hệ thống\nChi tiết: " + ex.Message); }
        }

        private void TxtTenKH_TextChanged(object sender, EventArgs e)
        {
            _dirtyInputs = true;
            if (!txtTenKH.Focused) return;
            var caret = txtTenKH.SelectionStart;
            var raw = Regex.Replace(txtTenKH.Text, @"[^\p{L} ]+", "");
            var text = CultureInfo.CurrentCulture.TextInfo.ToTitleCase(raw.ToLower());
            if (text != txtTenKH.Text) { txtTenKH.Text = text; txtTenKH.SelectionStart = Math.Min(caret, txtTenKH.Text.Length); }
        }

        private void MtxtCMND_TextChanged(object sender, EventArgs e)
        {
            _dirtyInputs = true;
            var digits = new string(mtxtCMND.Text.Where(char.IsDigit).ToArray());
            string formatted = digits.Length <= 9 
                ? Regex.Replace(digits, @"(\d{3})(\d{0,3})(\d{0,3})", m => string.Join("-", new[] { m.Groups[1].Value, m.Groups[2].Value, m.Groups[3].Value }.Where(s => s.Length > 0)))
                : Regex.Replace(digits, @"(\d{3})(\d{0,3})(\d{0,3})(\d{0,3})", m => string.Join("-", new[] { m.Groups[1].Value, m.Groups[2].Value, m.Groups[3].Value, m.Groups[4].Value }.Where(s => s.Length > 0)));
            int caret = mtxtCMND.SelectionStart; mtxtCMND.Text = formatted; mtxtCMND.SelectionStart = Math.Min(caret, mtxtCMND.Text.Length);
            mtxtCMND.BackColor = (digits.Length == 9 || digits.Length == 12) ? System.Drawing.Color.White : System.Drawing.Color.MistyRose;
        }

        private void MtxtSDTKH_TextChanged(object sender, EventArgs e)
        {
            _dirtyInputs = true;
            var digits = new string(mtxtSDTKH.Text.Where(char.IsDigit).ToArray());
            // format to 0xxx xxx xxx (10) or 0xxx xxx xxxx (11)
            string formatted;
            if (digits.Length <= 10)
            {
                formatted = Regex.Replace(digits, @"(\d{0,4})(\d{0,3})(\d{0,3})", m => string.Join(" ", new[] { m.Groups[1].Value, m.Groups[2].Value, m.Groups[3].Value }.Where(s => s.Length > 0)));
            }
            else
            {
                formatted = Regex.Replace(digits, @"(\d{0,4})(\d{0,3})(\d{0,4})", m => string.Join(" ", new[] { m.Groups[1].Value, m.Groups[2].Value, m.Groups[3].Value }.Where(s => s.Length > 0)));
            }
            int caret = mtxtSDTKH.SelectionStart; mtxtSDTKH.Text = formatted; mtxtSDTKH.SelectionStart = Math.Min(caret, mtxtSDTKH.Text.Length);
            mtxtSDTKH.BackColor = (digits.Length == 0 || Validators.IsValidVietnamPhone(digits)) ? System.Drawing.Color.White : System.Drawing.Color.MistyRose;
        }

        private void FrmKhachHang_FormClosing(object sender, FormClosingEventArgs e)
        {
            if (_dirtyInputs)
            {
                var ans = MessageBox.Show("Bạn có thay đổi chưa lưu. Có muốn lưu trước khi đóng?", "Xác nhận", MessageBoxButtons.YesNoCancel, MessageBoxIcon.Question);
                if (ans == DialogResult.Cancel) { e.Cancel = true; return; }
                if (ans == DialogResult.Yes)
                {
                    if (string.IsNullOrWhiteSpace(txtMaKH.Text)) BtnThem_Click(this, EventArgs.Empty);
                    else BtnSua_Click(this, EventArgs.Empty);
                }
            }
        }

 
    }
}
