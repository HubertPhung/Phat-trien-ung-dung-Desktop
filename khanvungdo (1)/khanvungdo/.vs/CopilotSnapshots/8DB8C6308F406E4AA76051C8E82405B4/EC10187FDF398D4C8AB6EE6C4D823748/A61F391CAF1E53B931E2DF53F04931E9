using System;
using System.Data;
using System.Data.SqlClient;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using System.Windows.Forms.DataVisualization.Charting;
using WindowsFormsApp2.Infrastructure;
using WindowsFormsApp2.Security;

namespace WindowsFormsApp2
{
    public partial class frmDoanhThu : Form
    {
        private bool _hasData;

        public frmDoanhThu()
        {
            InitializeComponent();
            btnXem.Click += BtnXem_Click;
            btnIn.Click += BtnIn_Click;
            chartDanhThu.GetToolTipText += ChartDanhThu_GetToolTipText;
            chartDanhThu.MouseDoubleClick += ChartDanhThu_MouseDoubleClick;
            lvDoanhThu.SelectedIndexChanged += LvDoanhThu_SelectedIndexChanged;

            // Ngày mặc định: đầu tháng -> hôm nay, định dạng "dd Tháng MMMM yyyy"
            var now = DateTime.Today;
            var firstOfMonth = new DateTime(now.Year, now.Month, 1);
            dtpTuNgay.Format = System.Windows.Forms.DateTimePickerFormat.Custom;
            dtpTuNgay.CustomFormat = "dd 'Tháng' MMMM yyyy";
            dtpDenNgay.Format = System.Windows.Forms.DateTimePickerFormat.Custom;
            dtpDenNgay.CustomFormat = "dd 'Tháng' MMMM yyyy";
            dtpTuNgay.Value = firstOfMonth;
            dtpDenNgay.Value = now;
        }

        private void frmDoanhThu_Load(object sender, EventArgs e)
        {
            // Quyền truy cập: chỉ Admin
            if (UserContext.Type != 1)
            {
                MessageBox.Show("Bạn không có quyền truy cập", "Cảnh báo", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                btnXem.Enabled = false;
                btnIn.Enabled = false;
                return;
            }

            // Kiểm tra kết nối nhanh
            try { using (var c = Db.Open()) { } }
            catch
            {
                MessageBox.Show("Không thể kết nối database", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
                btnXem.Enabled = false;
                btnIn.Enabled = false;
                return;
            }

            // Khởi tạo chart
            InitChart();

            // Tự động tải dữ liệu mặc định
            BtnXem_Click(btnXem, EventArgs.Empty);
        }

        private void InitChart()
        {
            chartDanhThu.Series.Clear();
            var s = new Series("Series1") { ChartType = SeriesChartType.Column, IsValueShownAsLabel = false };
            chartDanhThu.Series.Add(s);
            chartDanhThu.ChartAreas[0].AxisY.LabelStyle.Format = "#,0 VND";
            chartDanhThu.ChartAreas[0].AxisX.Interval = 1;
        }

        private bool ValidateRange(out DateTime tu, out DateTime den)
        {
            tu = dtpTuNgay.Value.Date;
            den = dtpDenNgay.Value.Date;
            if (den < tu)
            {
                MessageBox.Show("Từ ngày phải nhỏ hơn hoặc bằng Đến ngày");
                return false;
            }
            if ((den - tu).TotalDays > 365)
            {
                if (MessageBox.Show("Khoảng thời gian > 365 ngày. Tiếp tục?", "Cảnh báo", MessageBoxButtons.YesNo, MessageBoxIcon.Warning) != DialogResult.Yes)
                    return false;
            }
            // lấy hết ngày Đến
            den = den.AddDays(1).AddTicks(-1);
            return true;
        }

        private void SetBusy(bool busy)
        {
            Cursor.Current = busy ? Cursors.WaitCursor : Cursors.Default;
            btnXem.Enabled = !busy;
            btnIn.Enabled = !busy;
        }

        private void BtnXem_Click(object sender, EventArgs e)
        {
            if (!ValidateRange(out var tu, out var den)) return;

            try
            {
                SetBusy(true);
                LoadDoanhThu(tu, den);
                _hasData = lvDoanhThu.Items.Count > 0;
                MessageBox.Show(_hasData ? "Đã tải xong dữ liệu" : "Không có dữ liệu");
            }
            catch (Exception ex)
            {
                MessageBox.Show("Lỗi khi tải dữ liệu: " + ex.Message);
            }
            finally
            {
                SetBusy(false);
            }
        }

        private void LoadDoanhThu(DateTime tu, DateTime den)
        {
            // ListView
            lvDoanhThu.Items.Clear();

            // Chart
            var series = chartDanhThu.Series[0];
            series.Points.Clear();

            // Tổng hợp hóa đơn theo khoảng thời gian (đã thanh toán)
            decimal tongDV = 0, tienGiam = 0, tongDoanhThu = 0; int tongSoDV = 0;

            using (var conn = Db.Open())
            {
                // Doanh thu theo hóa đơn để tính giảm/tổng
                using (var cmd = new SqlCommand(@"SELECT hd.GiamGia, hd.TongTien, hd.ThanhTien
                                                FROM dbo.HoaDon hd
                                                WHERE hd.status = 1 AND hd.NgayLapHD >= @tu AND hd.NgayKetThucHD <= @den", conn))
                {
                    cmd.Parameters.AddWithValue("@tu", tu);
                    cmd.Parameters.AddWithValue("@den", den);
                    using (var rd = cmd.ExecuteReader())
                    {
                        while (rd.Read())
                        {
                            var giam = Convert.ToDecimal(rd["GiamGia"]);
                            var tong = Convert.ToDecimal(rd["TongTien"]);
                            var thanh = Convert.ToDecimal(rd["ThanhTien"]);
                            tienGiam += (tong - thanh);
                            tongDV += tong;
                            tongDoanhThu += thanh;
                        }
                    }
                }

                // Lấy chi tiết dịch vụ trong khoảng (gộp theo dịch vụ)
                using (var cmd2 = new SqlCommand(@"SELECT TOP 1000 dv.id AS MaDV, dv.TenDV, dv.DVT, SUM(ct.SoLuong) AS SoLuong, SUM(ct.ThanhTien) AS ThanhTien
                                                  FROM dbo.HoaDon hd
                                                  JOIN dbo.ChiTietHD ct ON ct.MaHD = hd.id
                                                  JOIN dbo.DSDichVu dv ON dv.id = ct.MaDV
                                                  WHERE hd.status = 1 AND hd.NgayLapHD >= @tu AND hd.NgayKetThucHD <= @den
                                                  GROUP BY dv.id, dv.TenDV, dv.DVT
                                                  ORDER BY SUM(ct.ThanhTien) DESC", conn))
                {
                    cmd2.Parameters.AddWithValue("@tu", tu);
                    cmd2.Parameters.AddWithValue("@den", den);

                    using (var rd2 = cmd2.ExecuteReader())
                    {
                        int idx = 0;
                        while (rd2.Read())
                        {
                            var ma = Convert.ToInt32(rd2["MaDV"]);
                            var ten = rd2["TenDV"].ToString();
                            var soLuong = Convert.ToInt32(rd2["SoLuong"]);
                            var dvt = rd2["DVT"].ToString();
                            var thanhTien = Convert.ToDecimal(rd2["ThanhTien"]);

                            var item = new ListViewItem(ma.ToString());
                            item.SubItems.Add(ten);
                            item.SubItems.Add(soLuong.ToString());
                            item.SubItems.Add(dvt);
                            item.SubItems.Add(string.Format("{0:N0}", thanhTien));
                            item.SubItems.Add("");
                            lvDoanhThu.Items.Add(item);

                            tongSoDV += soLuong;

                            // Top 8 vào chart
                            if (idx < 8)
                            {
                                var p = series.Points.AddY((double)thanhTien);
                                p.AxisLabel = ten;
                                p.LegendText = ten;
                                p.ToolTip = string.Format("{0:N0} VND", thanhTien);
                            }
                            idx++;
                        }
                    }
                }
            }

            // Thống kê
            txtTongDichVu.Text = string.Format("{0:N0} lượt", tongSoDV);
            txtTongTienDichVu.Text = string.Format("{0:N0} VND", tongDV);
            txtTienGiam.Text = string.Format("{0:N0} VND", tienGiam);
            var tong = Math.Max(0, tongDoanhThu);
            txtTongDoanhThu.Text = string.Format("{0:N0} VND", tong);

            // Màu sắc: dương xanh, âm đỏ (nếu có)
            txtTongDichVu.ForeColor = Color.SeaGreen;
            txtTongTienDichVu.ForeColor = Color.SeaGreen;
            txtTienGiam.ForeColor = tienGiam > 0 ? Color.IndianRed : Color.SeaGreen;
            txtTongDoanhThu.ForeColor = tong >= 0 ? Color.SeaGreen : Color.IndianRed;

            // Màu cột
            var palette = new[] { Color.SteelBlue, Color.CadetBlue, Color.MediumSeaGreen, Color.MediumSlateBlue, Color.Orange, Color.Salmon, Color.Goldenrod, Color.MediumPurple };
            for (int i = 0; i < series.Points.Count; i++)
            {
                series.Points[i].Color = palette[i % palette.Length];
            }
        }

        private void LvDoanhThu_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (lvDoanhThu.SelectedItems.Count == 0 || chartDanhThu.Series.Count == 0) return;
            var ten = lvDoanhThu.SelectedItems[0].SubItems[1].Text;
            var s = chartDanhThu.Series[0];
            foreach (var p in s.Points) p.BorderWidth = 1;
            foreach (var p in s.Points)
            {
                if (p.AxisLabel == ten)
                {
                    p.BorderWidth = 4; // highlight
                    break;
                }
            }
        }

        private void ChartDanhThu_GetToolTipText(object sender, ToolTipEventArgs e)
        {
            if (e.HitTestResult.ChartElementType == ChartElementType.DataPoint)
            {
                var dp = chartDanhThu.Series[0].Points[e.HitTestResult.PointIndex];
                e.Text = dp.AxisLabel + "\n" + string.Format("{0:N0} VND", dp.YValues[0]);
            }
        }

        private void ChartDanhThu_MouseDoubleClick(object sender, MouseEventArgs e)
        {
            var h = chartDanhThu.HitTest(e.X, e.Y);
            if (h.ChartElementType == ChartElementType.DataPoint)
            {
                var dp = chartDanhThu.Series[0].Points[h.PointIndex];
                using (var f = new frmChiTietDV())
                {
                    f.Text = "Chi tiết dịch vụ - " + dp.AxisLabel;
                    f.ShowDialog(this);
                }
            }
        }

        private void BtnIn_Click(object sender, EventArgs e)
        {
            if (!_hasData)
            {
                MessageBox.Show("Vui lòng xem dữ liệu trước khi in");
                return;
            }

            using (var sfd = new SaveFileDialog { Filter = "Excel Workbook (*.xls)|*.xls|PDF (*.pdf)|*.pdf", FileName = "BaoCaoDoanhThu.xls" })
            {
                if (sfd.ShowDialog() != DialogResult.OK) return;

                try
                {
                    if (sfd.FilterIndex == 1)
                    {
                        // Export Excel bằng HTML
                        var html = BuildExcelHtml();
                        var bytes = Encoding.UTF8.GetPreamble().Concat(Encoding.UTF8.GetBytes(html)).ToArray();
                        System.IO.File.WriteAllBytes(sfd.FileName, bytes);
                        MessageBox.Show("Đã xuất Excel.");
                    }
                    else
                    {
                        // In ra PDF qua máy in Microsoft Print to PDF (yêu cầu có trên máy)
                        using (var pd = new System.Drawing.Printing.PrintDocument())
                        {
                            pd.DocumentName = "Báo cáo doanh thu";
                            pd.PrintPage += (s, ev) => DrawReport(ev);
                            var pdlg = new PrintDialog { UseEXDialog = true, Document = pd, AllowSomePages = false, AllowPrintToFile = true, PrinterSettings = { PrintToFile = true, PrintFileName = sfd.FileName } };
                            if (pdlg.ShowDialog() == DialogResult.OK)
                            {
                                pd.PrinterSettings = pdlg.PrinterSettings;
                                pd.Print();
                                MessageBox.Show("Đã lưu file PDF");
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    MessageBox.Show("Lỗi khi in/xuất: " + ex.Message);
                }
            }
        }

        private void DrawReport(System.Drawing.Printing.PrintPageEventArgs ev)
        {
            float y = 40;
            var g = ev.Graphics;
            using (var titleFont = new Font("Segoe UI", 14, FontStyle.Bold))
            using (var normal = new Font("Segoe UI", 10))
            {
                g.DrawString("BÁO CÁO DOANH THU DỊCH VỤ", titleFont, Brushes.Black, 40, y); y += 30;
                g.DrawString($"Khoảng thời gian: {dtpTuNgay.Value:dd/MM/yyyy} - {dtpDenNgay.Value:dd/MM/yyyy}", normal, Brushes.Black, 40, y); y += 25;
                g.DrawString($"Tổng dịch vụ: {txtTongDichVu.Text}", normal, Brushes.Black, 40, y); y += 20;
                g.DrawString($"Tổng tiền dịch vụ: {txtTongTienDichVu.Text}", normal, Brushes.Black, 40, y); y += 20;
                g.DrawString($"Tiền giảm: {txtTienGiam.Text}", normal, Brushes.Black, 40, y); y += 20;
                g.DrawString($"Tổng doanh thu: {txtTongDoanhThu.Text}", normal, Brushes.Black, 40, y); y += 30;

                // Bảng dữ liệu đơn giản
                g.DrawString("Mã DV", normal, Brushes.Black, 40, y);
                g.DrawString("Tên DV", normal, Brushes.Black, 120, y);
                g.DrawString("SL", normal, Brushes.Black, 420, y);
                g.DrawString("DVT", normal, Brushes.Black, 470, y);
                g.DrawString("Thành tiền", normal, Brushes.Black, 540, y);
                y += 18;
                g.DrawLine(Pens.Black, 40, y, 750, y); y += 5;
                foreach (ListViewItem it in lvDoanhThu.Items)
                {
                    g.DrawString(it.SubItems[0].Text, normal, Brushes.Black, 40, y);
                    g.DrawString(it.SubItems[1].Text, normal, Brushes.Black, 120, y);
                    g.DrawString(it.SubItems[2].Text, normal, Brushes.Black, 420, y);
                    g.DrawString(it.SubItems[3].Text, normal, Brushes.Black, 470, y);
                    g.DrawString(it.SubItems[4].Text, normal, Brushes.Black, 540, y);
                    y += 18;
                    if (y > ev.MarginBounds.Bottom - 40) { ev.HasMorePages = true; return; }
                }
            }
        }

        private string BuildExcelHtml()
        {
            var sb = new StringBuilder();
            sb.AppendLine("<html><head><meta http-equiv='Content-Type' content='text/html; charset=utf-8' /></head><body>");
            sb.AppendLine($"<h2 style='text-align:center'>BÁO CÁO DOANH THU</h2>");
            sb.AppendLine($"<div>Khoảng thời gian: {dtpTuNgay.Value:dd/MM/yyyy} - {dtpDenNgay.Value:dd/MM/yyyy}</div>");

            sb.AppendLine("<table border='1' cellspacing='0' cellpadding='5'>");
            sb.Append("<tr>");
            foreach (ColumnHeader col in lvDoanhThu.Columns)
                sb.Append($"<th>{System.Security.SecurityElement.Escape(col.Text)}</th>");
            sb.AppendLine("</tr>");

            foreach (ListViewItem it in lvDoanhThu.Items)
            {
                sb.Append("<tr>");
                foreach (ListViewItem.ListViewSubItem sub in it.SubItems)
                {
                    var text = System.Security.SecurityElement.Escape(sub.Text);
                    sb.Append($"<td>{text}</td>");
                }
                sb.AppendLine("</tr>");
            }
            sb.AppendLine("</table>");

            sb.AppendLine("<br/>");
            sb.AppendLine("<table border='1' cellspacing='0' cellpadding='5'>");
            sb.AppendLine($"<tr><td>Tổng dịch vụ</td><td>{txtTongDichVu.Text}</td></tr>");
            sb.AppendLine($"<tr><td>Tổng tiền dịch vụ</td><td>{txtTongTienDichVu.Text}</td></tr>");
            sb.AppendLine($"<tr><td>Tiền giảm</td><td>{txtTienGiam.Text}</td></tr>");
            sb.AppendLine($"<tr><td>Tổng doanh thu</td><td>{txtTongDoanhThu.Text}</td></tr>");
            sb.AppendLine("</table>");

            sb.AppendLine("</body></html>");
            return sb.ToString();
        }
    }
}
