using System;
using System.Data;
using System.Data.SqlClient;
using System.Windows.Forms;
using WindowsFormsApp2.Infrastructure;

namespace WindowsFormsApp2
{
    public partial class frmHoaDon : Form
    {
        public frmHoaDon()
        {
            InitializeComponent();
        }

        private void frmHoaDon_Load(object sender, EventArgs e)
        {
            try
            {
                dtpLapTuNgay.Value = DateTime.Today.AddDays(-7);
                dtpDenNgay.Value = DateTime.Today;
                LoadPhongToCombo();
                LoadHoaDon();

                dtpLapTuNgay.ValueChanged += (s, ev) => LoadHoaDon();
                dtpDenNgay.ValueChanged += (s, ev) => LoadHoaDon();
                cbPhong.SelectionChangeCommitted += (s, ev) => LoadHoaDon();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Lỗi khi tải dữ liệu hóa đơn: " + ex.Message);
            }
        }

        private void LoadPhongToCombo()
        {
            cbPhong.Items.Clear();
            cbPhong.Items.Add("<Tất cả>");
            using (var conn = Db.Open())
            using (var cmd = new SqlCommand("SELECT id, TenPhong FROM dbo.Phong ORDER BY id", conn))
            using (var rd = cmd.ExecuteReader())
            {
                while (rd.Read())
                {
                    cbPhong.Items.Add(new ComboItem
                    {
                        Id = Convert.ToInt32(rd["id"]),
                        Text = rd["TenPhong"].ToString()
                    });
                }
            }
            cbPhong.SelectedIndex = 0;
        }

        private void LoadHoaDon()
        {
            lvHoaDon.Items.Clear();

            var from = dtpLapTuNgay.Value.Date;
            var to = dtpDenNgay.Value.Date.AddDays(1).AddTicks(-1);

            int? roomId = null;
            if (cbPhong.SelectedItem is ComboItem it)
                roomId = it.Id;

            string sql = @"SELECT hd.id, hd.NgayLapHD, hd.NgayKetThucHD, hd.MaPhong, hd.TongTien, hd.GiamGia, hd.ThanhTien,
                                   CASE WHEN hd.status = 1 THEN N'Đã thanh toán' ELSE N'Chưa thanh toán' END AS TrangThai
                            FROM dbo.HoaDon hd
                            WHERE hd.NgayLapHD >= @from AND hd.NgayLapHD <= @to";
            if (roomId.HasValue)
                sql += " AND hd.MaPhong = @room";

            sql += " ORDER BY hd.id DESC";

            using (var conn = Db.Open())
            using (var cmd = new SqlCommand(sql, conn))
            {
                cmd.Parameters.AddWithValue("@from", from);
                cmd.Parameters.AddWithValue("@to", to);
                if (roomId.HasValue) cmd.Parameters.AddWithValue("@room", roomId.Value);

                using (var rd = cmd.ExecuteReader())
                {
                    while (rd.Read())
                    {
                        var item = new ListViewItem(Convert.ToString(rd["id"]));
                        item.SubItems.Add(Convert.ToDateTime(rd["NgayLapHD"]).ToString("dd/MM/yyyy HH:mm"));
                        item.SubItems.Add(rd["NgayKetThucHD"] == DBNull.Value ? "" : Convert.ToDateTime(rd["NgayKetThucHD"]).ToString("dd/MM/yyyy HH:mm"));
                        item.SubItems.Add(Convert.ToString(rd["MaPhong"]));
                        item.SubItems.Add(string.Format("{0:N0}", rd["TongTien"]));
                        item.SubItems.Add(string.Format("{0:N0}%", rd["GiamGia"]));
                        item.SubItems.Add(string.Format("{0:N0}", rd["ThanhTien"]));
                        item.SubItems.Add(Convert.ToString(rd["TrangThai"]));
                        lvHoaDon.Items.Add(item);
                    }
                }
            }
        }

        private void cậpNhậpToolStripMenuItem_Click(object sender, EventArgs e)
        {
            // Mở chi tiết hóa đơn hoặc chỉnh sửa giảm giá/trạng thái nếu cần
            if (lvHoaDon.SelectedItems.Count == 0)
            {
                MessageBox.Show("Chọn một hóa đơn để cập nhật.");
                return;
            }
            var id = lvHoaDon.SelectedItems[0].Text;
            MessageBox.Show($"Hóa đơn {id}", "Thông tin");
        }

        private class ComboItem
        {
            public int Id { get; set; }
            public string Text { get; set; }
            public override string ToString() => Text;
        }
    }
}
