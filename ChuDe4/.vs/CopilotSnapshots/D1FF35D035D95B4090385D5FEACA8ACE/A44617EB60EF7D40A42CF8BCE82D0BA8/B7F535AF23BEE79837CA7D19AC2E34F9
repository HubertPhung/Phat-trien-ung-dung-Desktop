using System;
using System.Data.SqlClient;
using System.IO;
using System.Text.RegularExpressions;

namespace ChuDe4
{
 internal static class DbInitializer
 {
 private static bool _initialized;

 public static void EnsureDatabase()
 {
 if (_initialized) return;

 try
 {
 var baseDir = AppDomain.CurrentDomain.BaseDirectory;
 var path1 = Path.GetFullPath(Path.Combine(baseDir, @"..\\..\\Database\\RestaurantManagement.sql"));
 var path2 = Path.Combine(baseDir, @"Database\\RestaurantManagement.sql");
 var scriptPath = File.Exists(path1) ? path1 : (File.Exists(path2) ? path2 : null);

 if (string.IsNullOrEmpty(scriptPath))
 {
 _initialized = true; // nothing we can do; continue without throwing
 return;
 }

 string script = File.ReadAllText(scriptPath);

 // Connect to server (default DB = master)
 using (var conn = new SqlConnection("server=.; Integrated Security=true;"))
 {
 conn.Open();

 var batches = Regex.Split(script, @"^\s*GO\s*$", RegexOptions.Multiline | RegexOptions.IgnoreCase);
 foreach (var batch in batches)
 {
 var sql = batch.Trim();
 if (sql.Length ==0) continue;
 using (var cmd = new SqlCommand(sql, conn))
 {
 cmd.ExecuteNonQuery();
 }
 }
 }
 }
 catch
 {
 // Swallow to avoid crashing the app; user can run the script manually if needed
 }
 finally
 {
 _initialized = true;
 }
 }
 }
}
