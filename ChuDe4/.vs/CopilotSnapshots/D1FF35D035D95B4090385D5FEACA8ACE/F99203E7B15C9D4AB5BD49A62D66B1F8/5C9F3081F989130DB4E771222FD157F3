using System;
using System.Data;
using System.Data.SqlClient;
using System.Windows.Forms;

namespace ChuDe4
{
 public partial class MainForm : Form
 {
 private readonly DataAccess _db = new DataAccess();
 private int? _selectedTableId;

 public MainForm()
 {
 InitializeComponent();
 this.Load += MainForm_Load;
 dgvTables.SelectionChanged += DgvTables_SelectionChanged;
 btnAddTable.Click += BtnAddTable_Click;
 btnUpdateTable.Click += BtnUpdateTable_Click;
 btnDeleteTable.Click += BtnDeleteTable_Click;
 btnViewCurrentBill.Click += BtnViewCurrentBill_Click;
 tsmDeleteTable.Click += TsmDeleteTable_Click;
 tsmViewBillCatalog.Click += TsmViewBillCatalog_Click;
 tsmViewBillLog.Click += TsmViewBillLog_Click;
 }

 private void MainForm_Load(object sender, EventArgs e)
 {
 LoadTables();
 }

 private void LoadTables()
 {
 var dt = _db.ExecuteQuery("SELECT ID, Name, IsActive, Notes FROM Tables ORDER BY Name");
 dgvTables.DataSource = dt;
 if (dgvTables.Columns.Contains("ID")) dgvTables.Columns["ID"].Visible = false;
 if (dgvTables.Columns.Contains("Name")) dgvTables.Columns["Name"].HeaderText = "Tên bàn";
 if (dgvTables.Columns.Contains("IsActive")) dgvTables.Columns["IsActive"].HeaderText = "Kích hoạt";
 if (dgvTables.Columns.Contains("Notes")) dgvTables.Columns["Notes"].HeaderText = "Ghi chú";
 dgvTables.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
 dgvTables.ClearSelection();
 _selectedTableId = null;
 ClearTableEditor();
 }

 private void DgvTables_SelectionChanged(object sender, EventArgs e)
 {
 if (dgvTables.SelectedRows.Count >0)
 {
 var row = dgvTables.SelectedRows[0];
 _selectedTableId = Convert.ToInt32(row.Cells["ID"].Value);
 txtTableName.Text = row.Cells["Name"].Value?.ToString();
 var isActiveVal = row.Cells["IsActive"].Value;
 bool isActive = false;
 if (isActiveVal is bool) isActive = (bool)isActiveVal; else if (isActiveVal != null) bool.TryParse(isActiveVal.ToString(), out isActive);
 chkTableActive.Checked = isActive;
 txtNotes.Text = row.Cells["Notes"].Value?.ToString();
 }
 else
 {
 _selectedTableId = null;
 ClearTableEditor();
 }
 }

 private void ClearTableEditor()
 {
 txtTableName.Text = string.Empty;
 chkTableActive.Checked = true;
 txtNotes.Text = string.Empty;
 }

 private void BtnAddTable_Click(object sender, EventArgs e)
 {
 if (string.IsNullOrWhiteSpace(txtTableName.Text))
 {
 MessageBox.Show("Tên bàn không được để trống.", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Warning);
 return;
 }
 string sql = "INSERT INTO Tables (Name, IsActive, Notes) VALUES (@Name, @IsActive, @Notes)";
 var prms = new[]
 {
 new SqlParameter("@Name", txtTableName.Text.Trim()),
 new SqlParameter("@IsActive", chkTableActive.Checked),
 new SqlParameter("@Notes", (object)(txtNotes.Text??string.Empty))
 };
 try
 {
 _db.ExecuteNonQuery(sql, prms);
 LoadTables();
 }
 catch (SqlException ex)
 {
 MessageBox.Show("Không thể thêm bàn: " + ex.Message, "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
 }
 }

 private void BtnUpdateTable_Click(object sender, EventArgs e)
 {
 if (_selectedTableId == null)
 {
 MessageBox.Show("Chưa chọn bàn.", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
 return;
 }
 if (string.IsNullOrWhiteSpace(txtTableName.Text))
 {
 MessageBox.Show("Tên bàn không được để trống.", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Warning);
 return;
 }
 string sql = "UPDATE Tables SET Name=@Name, IsActive=@IsActive, Notes=@Notes WHERE ID=@ID";
 var prms = new[]
 {
 new SqlParameter("@Name", txtTableName.Text.Trim()),
 new SqlParameter("@IsActive", chkTableActive.Checked),
 new SqlParameter("@Notes", (object)(txtNotes.Text??string.Empty)),
 new SqlParameter("@ID", _selectedTableId.Value)
 };
 try
 {
 _db.ExecuteNonQuery(sql, prms);
 LoadTables();
 }
 catch (SqlException ex)
 {
 MessageBox.Show("Không thể cập nhật bàn: " + ex.Message, "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
 }
 }

 private void BtnDeleteTable_Click(object sender, EventArgs e)
 {
 DeleteSelectedTable();
 }

 private void TsmDeleteTable_Click(object sender, EventArgs e)
 {
 DeleteSelectedTable();
 }

 private void DeleteSelectedTable()
 {
 if (_selectedTableId == null) return;
 var name = txtTableName.Text;
 if (MessageBox.Show($"Xóa bàn '{name}'?", "Xác nhận", MessageBoxButtons.YesNo, MessageBoxIcon.Warning) != DialogResult.Yes) return;
 try
 {
 var prms = new[] { new SqlParameter("@ID", _selectedTableId.Value) };
 _db.ExecuteNonQuery("DELETE FROM Tables WHERE ID=@ID", prms);
 LoadTables();
 }
 catch (SqlException ex)
 {
 MessageBox.Show("Không thể xóa bàn (có thể đang có hóa đơn liên quan).\nChi tiết: " + ex.Message, "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
 }
 }

 private void BtnViewCurrentBill_Click(object sender, EventArgs e)
 {
 if (_selectedTableId == null)
 {
 MessageBox.Show("Chưa chọn bàn.", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
 return;
 }
 var prms = new[] { new SqlParameter("@TableID", _selectedTableId.Value) };
 var dt = _db.ExecuteQuery("SELECT TOP 1 ID FROM Bills WHERE TableID=@TableID AND IsPaid=0 ORDER BY CheckIn DESC", prms);
 if (dt.Rows.Count ==0)
 {
 MessageBox.Show("Bàn hiện không có hóa đơn mở.", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
 return;
 }
 int billId = Convert.ToInt32(dt.Rows[0]["ID"]);
 var frm = new BillDetailsForm(billId);
 frm.ShowDialog(this);
 }

 private void TsmViewBillCatalog_Click(object sender, EventArgs e)
 {
 if (_selectedTableId == null) return;
 var frm = new BillCatalogForm(_selectedTableId.Value, txtTableName.Text);
 frm.ShowDialog(this);
 }

 private void TsmViewBillLog_Click(object sender, EventArgs e)
 {
 var frm = new BillLogForm();
 frm.ShowDialog(this);
 }
 }
}
