using System;
using System.Data.SqlClient;
using System.IO;
using System.Text.RegularExpressions;

namespace ChuDe4
{
 internal static class DbInitializer
 {
 private static bool _initialized;

 /// <summary>
 /// Đảm bảo cơ sở dữ liệu RestaurantManagement và các đối tượng bắt buộc
 /// đã được tạo bằng cách thực thi script SQL đi kèm (chạy một lần mỗi phiên).
 /// </summary>
 public static void EnsureDatabase()
 {
 if (_initialized)
 return;

 try
 {
 // Xác định đường dẫn script SQL (ưu tiên trong thư mục dự án, sau đó tới thư mục chạy)
 var baseDir = AppDomain.CurrentDomain.BaseDirectory;
 var pathProject = Path.GetFullPath(Path.Combine(baseDir, @"..\\..\\Database\\RestaurantManagement.sql"));
 var pathOutput = Path.Combine(baseDir, @"Database\\RestaurantManagement.sql");
 var scriptPath = File.Exists(pathProject) ? pathProject : (File.Exists(pathOutput) ? pathOutput : null);

 if (string.IsNullOrEmpty(scriptPath))
 {
 // Không tìm thấy script; tiếp tục mà không ném ngoại lệ
 _initialized = true;
 return;
 }

 string script = File.ReadAllText(scriptPath);

 // Kết nối tới SQL Server (DB mặc định = master)
 using (var conn = new SqlConnection("server=.; Integrated Security=true;"))
 {
 conn.Open();

 // Tách script theo từ khóa GO (SqlClient không hiểu GO)
 var batches = Regex.Split(script, @"^\s*GO\s*$", RegexOptions.Multiline | RegexOptions.IgnoreCase);
 foreach (var batch in batches)
 {
 var sql = batch.Trim();
 if (sql.Length ==0)
 continue;

 using (var cmd = new SqlCommand(sql, conn))
 {
 cmd.ExecuteNonQuery();
 }
 }
 }
 }
 catch
 {
 // Bắt và bỏ qua lỗi để tránh làm sập ứng dụng;
 // người dùng có thể chạy script thủ công nếu cần.
 }
 finally
 {
 _initialized = true;
 }
 }
 }
}
