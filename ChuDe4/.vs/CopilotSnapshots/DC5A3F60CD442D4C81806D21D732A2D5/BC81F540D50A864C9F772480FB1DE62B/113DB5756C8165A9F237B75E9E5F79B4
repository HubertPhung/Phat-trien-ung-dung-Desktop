// AccountManager.cs
using System;
using System.Data;
using System.Data.SqlClient;
using System.Windows.Forms;

namespace ChuDe4
{
    public partial class AccountManager : Form
    {
        private DataAccess db = new DataAccess();

        public AccountManager()
        {
            InitializeComponent();

            // Wire up events
            this.Load += AccountManager_Load;
            this.dgvAccounts.SelectionChanged += dgvAccounts_SelectionChanged;
            this.btnAdd.Click += btnAdd_Click;
            this.btnUpdate.Click += btnUpdate_Click;
            this.btnResetPassword.Click += btnResetPassword_Click;
            this.tsmDelete.Click += tsmDelete_Click;
            this.tsmViewRoles.Click += tsmViewRoles_Click;
        }

        private void AccountManager_Load(object sender, EventArgs e)
        {
            LoadFilterComboBoxes();
            LoadAccounts();
        }

        private void LoadFilterComboBoxes()
        {
            // Load Account Groups
            cboAccountGroup.Items.Add("T?t c?");
            string query = "SELECT DISTINCT [Group] FROM Accounts WHERE [Group] IS NOT NULL";
            DataTable groupTable = db.ExecuteQuery(query);
            foreach (DataRow row in groupTable.Rows)
            {
                cboAccountGroup.Items.Add(row["Group"].ToString());
            }
            cboAccountGroup.SelectedIndex = 0;

            // Load Status
            cboStatus.Items.Add("Ngưng ho?t đ?ng"); // value = 0
            cboStatus.Items.Add("Ho?t đ?ng"); // value = 1
            cboStatus.Items.Add("T?t c?"); // value = 2
            cboStatus.SelectedIndex = 1;

            // T? đ?ng t?i l?i khi thay đ?i l?a ch?n
            cboAccountGroup.SelectedIndexChanged += (s, ev) => LoadAccounts();
            cboStatus.SelectedIndexChanged += (s, ev) => LoadAccounts();
        }

        private void LoadAccounts()
        {
            string query = "SELECT ID, UserName, DisplayName, [Group], IsActive FROM Accounts WHERE 1=1";
            var parameters = new System.Collections.Generic.List<SqlParameter>();

            if (cboAccountGroup.SelectedIndex > 0)
            {
                query += " AND [Group] = @Group";
                parameters.Add(new SqlParameter("@Group", cboAccountGroup.SelectedItem.ToString()));
            }

            if (cboStatus.SelectedIndex != 2)
            {
                query += " AND IsActive = @IsActive";
                parameters.Add(new SqlParameter("@IsActive", cboStatus.SelectedIndex));
            }

            dgvAccounts.DataSource = db.ExecuteQuery(query, parameters.ToArray());
            if (dgvAccounts.Columns.Contains("ID")) dgvAccounts.Columns["ID"].Visible = false; // ?n c?t ID
            if (dgvAccounts.Columns.Contains("UserName")) dgvAccounts.Columns["UserName"].HeaderText = "Tên đăng nh?p";
            if (dgvAccounts.Columns.Contains("DisplayName")) dgvAccounts.Columns["DisplayName"].HeaderText = "Tên hi?n th?";
            if (dgvAccounts.Columns.Contains("Group")) dgvAccounts.Columns["Group"].HeaderText = "Nhóm";
            if (dgvAccounts.Columns.Contains("IsActive")) dgvAccounts.Columns["IsActive"].HeaderText = "Kích ho?t";
            dgvAccounts.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;

            // Tránh t? đ?ng ch?n d?ng đ?u tiên
            dgvAccounts.ClearSelection();
        }

        private void dgvAccounts_SelectionChanged(object sender, EventArgs e)
        {
            if (dgvAccounts.SelectedRows.Count > 0)
            {
                var row = dgvAccounts.SelectedRows[0];
                txtUsername.Text = row.Cells["UserName"].Value.ToString();
                txtFullName.Text = row.Cells["DisplayName"].Value.ToString();
                // L?y thêm các trư?ng khác n?u có trên form (email, tel)
                var isActiveVal = row.Cells["IsActive"].Value;
                bool isActive = false;
                if (isActiveVal is bool) isActive = (bool)isActiveVal;
                else if (isActiveVal != null) bool.TryParse(isActiveVal.ToString(), out isActive);
                chkActive.Checked = isActive;

                txtUsername.Enabled = false; // Không cho s?a tên đăng nh?p (khóa chính logic)
                btnAdd.Enabled = false;
                btnUpdate.Enabled = true;
            }
            else
            {
                ClearForm();
            }
        }

        private void ClearForm()
        {
            txtUsername.Text = "";
            txtFullName.Text = "";
            chkActive.Checked = false;
            txtUsername.Enabled = true;
            btnAdd.Enabled = true;
            btnUpdate.Enabled = false;
            dgvAccounts.ClearSelection();
        }

        private void btnAdd_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrWhiteSpace(txtUsername.Text))
            {
                MessageBox.Show("Tên đăng nh?p không đư?c đ? tr?ng.", "L?i", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            // M?t kh?u m?c đ?nh, nên có cơ ch? t?o m?t kh?u an toàn hơn
            string defaultPassword = "123"; // TODO: Nên m? hóa m?t kh?u này

            string query = "INSERT INTO Accounts (UserName, DisplayName, Password, [Group], IsActive) VALUES (@UserName, @DisplayName, @Password, @Group, @IsActive)";
            SqlParameter[] parameters = {
                new SqlParameter("@UserName", txtUsername.Text),
                new SqlParameter("@DisplayName", txtFullName.Text),
                new SqlParameter("@Password", defaultPassword),
                new SqlParameter("@Group", "Staff"), // Gi? s? m?c đ?nh là Staff
                new SqlParameter("@IsActive", chkActive.Checked)
            };

            try
            {
                if (db.ExecuteNonQuery(query, parameters) > 0)
                {
                    MessageBox.Show("Thêm tài kho?n thành công!", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    LoadAccounts();
                    ClearForm();
                }
            }
            catch (SqlException ex) when (ex.Number == 2627) // L?i UNIQUE constraint
            {
                MessageBox.Show("Tên đăng nh?p đ? t?n t?i. Vui l?ng ch?n tên khác.", "L?i", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            catch (Exception ex)
            {
                MessageBox.Show("Đ? x?y ra l?i: " + ex.Message, "L?i", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void btnUpdate_Click(object sender, EventArgs e)
        {
            if (dgvAccounts.SelectedRows.Count == 0) return;

            int accountId = (int)dgvAccounts.SelectedRows[0].Cells["ID"].Value;

            string query = "UPDATE Accounts SET DisplayName = @DisplayName, IsActive = @IsActive WHERE ID = @ID";
            SqlParameter[] parameters = {
                new SqlParameter("@DisplayName", txtFullName.Text),
                new SqlParameter("@IsActive", chkActive.Checked),
                new SqlParameter("@ID", accountId)
            };

            if (db.ExecuteNonQuery(query, parameters) > 0)
            {
                MessageBox.Show("C?p nh?t thành công!", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                LoadAccounts();
            }
        }

        private void btnResetPassword_Click(object sender, EventArgs e)
        {
            if (dgvAccounts.SelectedRows.Count == 0) return;

            var row = dgvAccounts.SelectedRows[0];
            int accountId = (int)row.Cells["ID"].Value;
            string username = row.Cells["UserName"].Value.ToString();
            string defaultPassword = "123"; // TODO: M? hóa m?t kh?u

            if (MessageBox.Show($"B?n có ch?c mu?n đ?t l?i m?t kh?u cho '{username}'?", "Xác nh?n", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
            {
                string query = "UPDATE Accounts SET Password = @Password WHERE ID = @ID";
                SqlParameter[] parameters = {
                    new SqlParameter("@Password", defaultPassword),
                    new SqlParameter("@ID", accountId)
                };

                if (db.ExecuteNonQuery(query, parameters) > 0)
                {
                    MessageBox.Show($"M?t kh?u c?a '{username}' đ? đư?c đ?t l?i thành '{defaultPassword}'.", "Thành công", MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }
        }

        // --- Context Menu Events ---

        private void tsmDelete_Click(object sender, EventArgs e)
        {
            if (dgvAccounts.SelectedRows.Count == 0) return;

            int accountId = (int)dgvAccounts.SelectedRows[0].Cells["ID"].Value;
            string username = dgvAccounts.SelectedRows[0].Cells["UserName"].Value.ToString();

            if (MessageBox.Show($"Thao tác này s? ngưng kích ho?t toàn b? vai tr? c?a tài kho?n '{username}'. B?n có ch?c ch?n?", "Xác nh?n", MessageBoxButtons.YesNo, MessageBoxIcon.Warning) == DialogResult.Yes)
            {
                // Theo yêu c?u, ch? đánh d?u không kích ho?t vai tr?. 
                // Th?c t?, b?n c?ng có th? mu?n ngưng kích ho?t c? tài kho?n.
                string query = "UPDATE AccountRoles SET IsActive = 0 WHERE AccountID = @AccountID";
                SqlParameter[] parameters = { new SqlParameter("@AccountID", accountId) };

                int rowsAffected = db.ExecuteNonQuery(query, parameters);
                MessageBox.Show($"Đ? ngưng kích ho?t {rowsAffected} vai tr? c?a tài kho?n '{username}'.", "Hoàn t?t", MessageBoxButtons.OK, MessageBoxIcon.Information);

                // Tùy ch?n: Ngưng kích ho?t luôn tài kho?n
                // string queryAcc = "UPDATE Accounts SET IsActive = 0 WHERE ID = @ID";
                // db.ExecuteNonQuery(queryAcc, new SqlParameter[] { new SqlParameter("@ID", accountId) });
                // LoadAccounts();
            }
        }

        private void tsmViewRoles_Click(object sender, EventArgs e)
        {
            if (dgvAccounts.SelectedRows.Count > 0)
            {
                int accountId = (int)dgvAccounts.SelectedRows[0].Cells["ID"].Value;
                string username = dgvAccounts.SelectedRows[0].Cells["UserName"].Value.ToString();

                var rolesForm = new AccountRolesForm(accountId, username);
                rolesForm.ShowDialog();
            }
        }
    }
}