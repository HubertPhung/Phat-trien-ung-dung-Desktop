using System;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Windows.Forms;

namespace ChuDe4
{
    public partial class AccountManager : Form
    {
        private readonly string _connectionString = "server=.; database=RestaurantManagement; Integrated Security=true;";
        private const string AllLabel = "Tất cả";
        private bool _loading;

        public AccountManager()
        {
            InitializeComponent();

            // Wire events
            this.Load += AccountManager_Load;
            cboAccountGroup.SelectedIndexChanged += Filter_Changed;
            cboStatus.SelectedIndexChanged += Filter_Changed;
            dgvAccounts.SelectionChanged += DgvAccounts_SelectionChanged;
            btnAdd.Click += BtnAdd_Click;
            btnUpdate.Click += BtnUpdate_Click;
            btnResetPassword.Click += BtnResetPassword_Click;
            tsmDelete.Click += TsmDelete_Click;
            tsmViewRoles.Click += TsmViewRoles_Click;
        }

        private void AccountManager_Load(object sender, EventArgs e)
        {
            try
            {
                _loading = true;
                LoadAccountGroups();
                LoadStatusOptions();
                LoadAccounts();
            }
            finally
            {
                _loading = false;
            }
        }

        private void LoadAccountGroups()
        {
            cboAccountGroup.Items.Clear();
            cboAccountGroup.Items.Add(AllLabel);

            using (var conn = new SqlConnection(_connectionString))
            using (var cmd = conn.CreateCommand())
            {
                cmd.CommandText = "SELECT DISTINCT [Group] FROM dbo.Accounts WHERE [Group] IS NOT NULL AND LTRIM(RTRIM([Group]))<>'' ORDER BY [Group]";
                conn.Open();
                using (var reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        cboAccountGroup.Items.Add(reader.GetString(0));
                    }
                }
            }

            cboAccountGroup.SelectedIndex =0; // Tất cả
        }

        private void LoadStatusOptions()
        {
            // Use simple labels mapped to nullable filter
            cboStatus.Items.Clear();
            cboStatus.Items.Add(AllLabel); // index0
            cboStatus.Items.Add("Kích hoạt"); // index1 -> true
            cboStatus.Items.Add("Không kích hoạt"); // index2 -> false
            cboStatus.SelectedIndex =0;
        }

        private void Filter_Changed(object sender, EventArgs e)
        {
            if (_loading) return;
            LoadAccounts();
        }

        private void LoadAccounts()
        {
            string selectedGroup = cboAccountGroup.SelectedItem as string;
            string selectedStatus = cboStatus.SelectedItem as string;

            using (var conn = new SqlConnection(_connectionString))
            using (var cmd = conn.CreateCommand())
            {
                cmd.CommandText = @"SELECT ID, UserName, DisplayName, Email, Tel, [Group], IsActive
                                    FROM dbo.Accounts
                                    WHERE ( @grp IS NULL OR [Group] = @grp )
                                    AND ( @st IS NULL OR IsActive = @st )
                                    ORDER BY UserName";

                var grpParam = cmd.Parameters.Add("@grp", SqlDbType.NVarChar,50);
                if (!string.IsNullOrWhiteSpace(selectedGroup) && selectedGroup != AllLabel)
                    grpParam.Value = selectedGroup;
                else
                    grpParam.Value = DBNull.Value;

                var stParam = cmd.Parameters.Add("@st", SqlDbType.Bit);
                if (selectedStatus == "Kích hoạt") stParam.Value = true;
                else if (selectedStatus == "Không kích hoạt") stParam.Value = false;
                else stParam.Value = DBNull.Value;

                using (var da = new SqlDataAdapter(cmd))
                {
                    var dt = new DataTable();
                    da.Fill(dt);
                    dgvAccounts.DataSource = dt;
                }
            }

            if (dgvAccounts.Columns.Count >0)
            {
                dgvAccounts.Columns[0].HeaderText = "ID";
                dgvAccounts.Columns[1].HeaderText = "Tên đăng nhập";
                dgvAccounts.Columns[2].HeaderText = "Tên hiển thị";
                dgvAccounts.Columns[3].HeaderText = "Email";
                dgvAccounts.Columns[4].HeaderText = "Điện thoại";
                dgvAccounts.Columns[5].HeaderText = "Nhóm";
                dgvAccounts.Columns[6].HeaderText = "Kích hoạt";
                dgvAccounts.AutoResizeColumns();
            }
        }

        private void DgvAccounts_SelectionChanged(object sender, EventArgs e)
        {
            if (dgvAccounts.CurrentRow == null) return;
            var row = dgvAccounts.CurrentRow;
            txtUsername.Text = Convert.ToString(row.Cells[1].Value ?? "");
            txtFullName.Text = Convert.ToString(row.Cells[2].Value ?? "");
            txtEmail.Text = Convert.ToString(row.Cells[3].Value ?? "");
            txtTel.Text = Convert.ToString(row.Cells[4].Value ?? "");
            chkActive.Checked = ToBool(row.Cells[6].Value);
        }

        private static bool ToBool(object value)
        {
            if (value == null || value == DBNull.Value) return false;
            bool b;
            if (value is bool) return (bool)value;
            if (bool.TryParse(value.ToString(), out b)) return b;
            int i;
            if (int.TryParse(value.ToString(), out i)) return i !=0;
            return false;
        }

        private int? GetSelectedAccountId()
        {
            if (dgvAccounts.CurrentRow == null) return null;
            int id;
            if (int.TryParse(Convert.ToString(dgvAccounts.CurrentRow.Cells[0].Value), out id)) return id;
            return null;
        }

        private void BtnAdd_Click(object sender, EventArgs e)
        {
            var username = (txtUsername.Text ?? string.Empty).Trim();
            var display = (txtFullName.Text ?? string.Empty).Trim();
            var email = (txtEmail.Text ?? string.Empty).Trim();
            var tel = (txtTel.Text ?? string.Empty).Trim();
            var active = chkActive.Checked;

            if (string.IsNullOrEmpty(username)) { MessageBox.Show("Vui lòng nhập tên đăng nhập."); return; }
            if (string.IsNullOrEmpty(display)) { MessageBox.Show("Vui lòng nhập tên hiển thị."); return; }

            string selectedGroup = cboAccountGroup.SelectedItem as string;
            string groupVal = (!string.IsNullOrWhiteSpace(selectedGroup) && selectedGroup != AllLabel) ? selectedGroup : null;

            using (var conn = new SqlConnection(_connectionString))
            using (var cmd = conn.CreateCommand())
            {
                cmd.CommandText = @"INSERT INTO dbo.Accounts (UserName, DisplayName, Password, [Group], IsActive, Email, Tel)
                                    VALUES (@u, @d, @p, @g, @a, @e, @t)";
                cmd.Parameters.Add("@u", SqlDbType.NVarChar,100).Value = username;
                cmd.Parameters.Add("@d", SqlDbType.NVarChar,200).Value = display;
                cmd.Parameters.Add("@p", SqlDbType.NVarChar,256).Value = "123456"; // default password
                if (groupVal == null) cmd.Parameters.Add("@g", SqlDbType.NVarChar,50).Value = DBNull.Value; else cmd.Parameters.Add("@g", SqlDbType.NVarChar,50).Value = groupVal;
                cmd.Parameters.Add("@a", SqlDbType.Bit).Value = active;
                if (string.IsNullOrEmpty(email)) cmd.Parameters.Add("@e", SqlDbType.NVarChar,200).Value = DBNull.Value; else cmd.Parameters.Add("@e", SqlDbType.NVarChar,200).Value = email;
                if (string.IsNullOrEmpty(tel)) cmd.Parameters.Add("@t", SqlDbType.NVarChar,50).Value = DBNull.Value; else cmd.Parameters.Add("@t", SqlDbType.NVarChar,50).Value = tel;

                conn.Open();
                try
                {
                    cmd.ExecuteNonQuery();
                    MessageBox.Show("Thêm tài khoản thành công.");
                    LoadAccounts();
                }
                catch (SqlException ex)
                {
                    if (ex.Number ==2627 || ex.Number ==2601)
                        MessageBox.Show("Tên đăng nhập đã tồn tại.");
                    else
                        MessageBox.Show("Lỗi khi thêm tài khoản: " + ex.Message);
                }
            }
        }

        private void BtnUpdate_Click(object sender, EventArgs e)
        {
            var id = GetSelectedAccountId();
            if (id == null) { MessageBox.Show("Vui lòng chọn tài khoản."); return; }

            var display = (txtFullName.Text ?? string.Empty).Trim();
            var email = (txtEmail.Text ?? string.Empty).Trim();
            var tel = (txtTel.Text ?? string.Empty).Trim();
            var active = chkActive.Checked;

            if (string.IsNullOrEmpty(display)) { MessageBox.Show("Vui lòng nhập tên hiển thị."); return; }

            string selectedGroup = cboAccountGroup.SelectedItem as string;
            string groupVal = (!string.IsNullOrWhiteSpace(selectedGroup) && selectedGroup != AllLabel) ? selectedGroup : null; // null -> keep current

            using (var conn = new SqlConnection(_connectionString))
            using (var cmd = conn.CreateCommand())
            {
                cmd.CommandText = @"UPDATE dbo.Accounts
                                    SET DisplayName = @d,
                                        Email = @e,
                                        Tel = @t,
                                        IsActive = @a,
                                        [Group] = COALESCE(@g, [Group])
                                    WHERE ID = @id";
                cmd.Parameters.Add("@id", SqlDbType.Int).Value = id.Value;
                cmd.Parameters.Add("@d", SqlDbType.NVarChar,200).Value = display;
                if (string.IsNullOrEmpty(email)) cmd.Parameters.Add("@e", SqlDbType.NVarChar,200).Value = DBNull.Value; else cmd.Parameters.Add("@e", SqlDbType.NVarChar,200).Value = email;
                if (string.IsNullOrEmpty(tel)) cmd.Parameters.Add("@t", SqlDbType.NVarChar,50).Value = DBNull.Value; else cmd.Parameters.Add("@t", SqlDbType.NVarChar,50).Value = tel;
                if (groupVal == null) cmd.Parameters.Add("@g", SqlDbType.NVarChar,50).Value = DBNull.Value; else cmd.Parameters.Add("@g", SqlDbType.NVarChar,50).Value = groupVal;
                cmd.Parameters.Add("@a", SqlDbType.Bit).Value = active;

                conn.Open();
                int n = cmd.ExecuteNonQuery();
                if (n >0)
                {
                    MessageBox.Show("Cập nhật tài khoản thành công.");
                    LoadAccounts();
                }
                else
                {
                    MessageBox.Show("Không có bản ghi nào được cập nhật.");
                }
            }
        }

        private void BtnResetPassword_Click(object sender, EventArgs e)
        {
            var id = GetSelectedAccountId();
            if (id == null) { MessageBox.Show("Vui lòng chọn tài khoản."); return; }

            if (MessageBox.Show("Xác nhận reset mật khẩu về '123456'?", "Xác nhận", MessageBoxButtons.YesNo, MessageBoxIcon.Question) != DialogResult.Yes)
                return;

            using (var conn = new SqlConnection(_connectionString))
            using (var cmd = conn.CreateCommand())
            {
                cmd.CommandText = "UPDATE dbo.Accounts SET [Password] = @p WHERE ID = @id";
                cmd.Parameters.Add("@id", SqlDbType.Int).Value = id.Value;
                cmd.Parameters.Add("@p", SqlDbType.NVarChar,256).Value = "123456";
                conn.Open();
                cmd.ExecuteNonQuery();
                MessageBox.Show("Đã reset mật khẩu.");
            }
        }

        private void TsmDelete_Click(object sender, EventArgs e)
        {
            var id = GetSelectedAccountId();
            if (id == null) { MessageBox.Show("Vui lòng chọn tài khoản."); return; }
            if (MessageBox.Show("Bạn có chắc muốn xóa tài khoản này?", "Xác nhận", MessageBoxButtons.YesNo, MessageBoxIcon.Warning) != DialogResult.Yes)
                return;

            using (var conn = new SqlConnection(_connectionString))
            using (var cmd = conn.CreateCommand())
            {
                conn.Open();
                using (var tran = conn.BeginTransaction())
                {
                    cmd.Transaction = tran;
                    try
                    {
                        cmd.CommandText = "DELETE FROM dbo.AccountRoles WHERE AccountID=@id";
                        cmd.Parameters.Clear();
                        cmd.Parameters.Add("@id", SqlDbType.Int).Value = id.Value;
                        cmd.ExecuteNonQuery();

                        cmd.CommandText = "DELETE FROM dbo.Accounts WHERE ID=@id";
                        cmd.Parameters.Clear();
                        cmd.Parameters.Add("@id", SqlDbType.Int).Value = id.Value;
                        int n = cmd.ExecuteNonQuery();

                        tran.Commit();
                        if (n >0)
                        {
                            MessageBox.Show("Đã xóa tài khoản.");
                            LoadAccounts();
                        }
                        else
                        {
                            MessageBox.Show("Không tìm thấy tài khoản để xóa.");
                        }
                    }
                    catch (Exception ex)
                    {
                        tran.Rollback();
                        MessageBox.Show("Lỗi khi xóa: " + ex.Message);
                    }
                }
            }
        }

        private void TsmViewRoles_Click(object sender, EventArgs e)
        {
            var id = GetSelectedAccountId();
            if (id == null) { MessageBox.Show("Vui lòng chọn tài khoản."); return; }

            using (var conn = new SqlConnection(_connectionString))
            using (var cmd = conn.CreateCommand())
            {
                cmd.CommandText = @"SELECT r.RoleName
                                    FROM dbo.Roles r
                                    JOIN dbo.AccountRoles ar ON ar.RoleID = r.ID
                                    WHERE ar.AccountID = @id AND ar.IsActive =1
                                    ORDER BY r.RoleName";
                cmd.Parameters.Add("@id", SqlDbType.Int).Value = id.Value;
                conn.Open();
                using (var reader = cmd.ExecuteReader())
                {
                    var roles = new System.Text.StringBuilder();
                    while (reader.Read())
                    {
                        roles.AppendLine("- " + reader.GetString(0));
                    }
                    var content = roles.Length ==0 ? "Tài khoản chưa được gán vai trò nào." : roles.ToString();
                    MessageBox.Show(content, "Danh sách vai trò");
                }
            }
        }
    }
}
